<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Adopting the {loadbalancer_service} :: Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../../..">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="REPLACEREPONAME" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">FIXME Course Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prereqs.html">Perform OpenShift Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install-operators.html">Install the Red Hat OpenStack Platform Service Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../network-isolation.html">Prepare OCP for OpenStack Network Isolation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-overview.html">RHOSP 17.1 to RHOSO 18 adoption overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migrating-databases.html">Migrating RHOSP 17.1 Database to RHOSO 18</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-cp.html">Control plane Adoption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-dp.html">Option - Data plane Adoption</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter1/index.html">Chapter 1</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section2.html">Section 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section3.html">Section 3</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter2/index.html">Chapter 2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter2/section1.html">Section 1</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter3/index.html">Chapter 3</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section2.html">Section 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">FIXME Course Title</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">FIXME Course Title</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">FIXME Course Title</a></li>
    <li><a href="proc_adopting-the-loadbalancer-service.html">Adopting the {loadbalancer_service}</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Adopting the {loadbalancer_service}</h1>
<div class="paragraph _abstract">
<p>To adopt the {loadbalancer_first_ref}, you patch an existing <code>OpenStackControlPlane</code> custom resource (CR) where the {loadbalancer_service} is disabled. The patch starts the service with the configuration parameters that are provided by the {rhos_prev_long} ({OpenStackShort}) environment. Existing load balancers fail over after the adoption process to upgrade their image, and set up a network connection with the new control plane.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an alias for the <code>openstack</code> command:</p>
<div class="listingblock">
<div class="content">
<pre>$ alias openstack="oc exec -t openstackclient -- openstack"</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>CONTROLLER1_SCP</code> shell variable to set the value of the existing
<code>CONTROLLER1_SSH</code> variable:</p>
<div class="listingblock">
<div class="content">
<pre>$ CONTROLLER1_SCP=$(echo "$CONTROLLER1_SSH" | sed 's/^ssh/scp/g')</pre>
</div>
</div>
</li>
<li>
<p>Run the following set of commands to regenerate the keys and certificates and install the data in {rhocp_long}. Convert the existing single certificate authority (CA) configuration into a dual CA configuration. You can use these commands to regenerate the keys and certificates and insert them into {OpenShiftShort}:</p>
<div class="listingblock">
<div class="content">
<pre>Unresolved include directive in modules/ROOT/pages/adoption/modules/proc_adopting-the-loadbalancer-service.adoc - include::../../tests/roles/octavia_adoption/tasks/octavia_certs.yaml[]</pre>
</div>
</div>
</li>
<li>
<p>Optional: Copy the existing public SSH key that you can use for connecting to the amphorae and install it into {OpenShiftShort}:</p>
<div class="listingblock">
<div class="content">
<pre>    ${CONTROLLER1_SCP}:&lt;octavia_ssh_pubkey_path&gt; $HOME/octavia_sshkey.pub

    # Install new data in k8s
    oc apply -f - &lt;&lt;EOF
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: octavia-ssh-pubkey
    data:
      key: $(cat $HOME/octavia_sshkey.pub)
    EOF

    rm -f $HOME/octavia_sshkey.pub</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;octavia_ssh_pubkey_path&gt;</code> with the path that you configured by using the <code>OctaviaAmphoraSshKeyFile</code> parameter in the previous deployment. The default path is <code>/etc/octavia/ssh/octavia_id_rsa</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre>parameter_defaults:
    OctaviaAmphoraSshKeyFile: /etc/octavia/ssh/octavia_id_rsa</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>To isolate the management network, add the network interface for the VLAN base interface:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc get --no-headers nncp | cut -f 1 -d ' ' | grep -v nncp-dns | while read; do

interfaces=$(oc get nncp $REPLY -o jsonpath="{.spec.desiredState.interfaces[*].name}")

(echo $interfaces | grep -w -q "octbr\|enp6s0.24") || \
        oc patch nncp $REPLY --type json --patch '
[{
    "op": "add",
    "path": "/spec/desiredState/interfaces/-",
    "value": {
      "description": "Octavia VLAN host interface",
      "name": "enp6s0.24",
      "state": "up",
      "type": "vlan",
      "vlan": {
        "base-iface": "&lt;enp6s0&gt;", <i class="conum" data-value="1"></i><b>(1)</b>
        "id": 24
        }
    }
},
{
    "op": "add",
    "path": "/spec/desiredState/interfaces/-",
    "value": {
      "description": "Octavia Bridge",
      "mtu": &lt;mtu&gt;, <i class="conum" data-value="2"></i><b>(2)</b>
      "state": "up",
      "type": "linux-bridge",
      "name": "octbr",
      "bridge": {
        "options": { "stp": { "enabled": "false" } },
        "port": [ { "name": "enp6s0.24" } ]
        }
    }
}]'

done</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>&lt;enp6s0&gt;</code> with the name of the network interface in your {OpenShiftShort} setup.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>&lt;mtu&gt;</code> with the <code>mtu</code> value in your environment.</td>
</tr>
</table>
</div>
</li>
<li>
<p>To connect pods that manage load balancer virtual machines (amphorae) and the OpenvSwitch pods that are managed by the OVN operator, configure the {loadbalancer_service} network attachment definition:</p>
<div class="listingblock">
<div class="content">
<pre>$ cat &gt;&gt; octavia-nad.yaml &lt;&lt; EOF_CAT
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  labels:
    osp/net: octavia
  name: octavia
spec:
  config: |
    {
      "cniVersion": "0.3.1",
      "name": "octavia",
      "type": "bridge",
      "bridge": "octbr",
      "ipam": {
        "type": "whereabouts",
        "range": "172.23.0.0/24",
        "range_start": "172.23.0.30",
        "range_end": "172.23.0.70",
        "routes": [
           {
             "dst": "172.24.0.0/16",
             "gw" : "172.23.0.150"
           }
         ]
      }
    }
EOF_CAT
$ oc apply -f octavia-nad.yaml</pre>
</div>
</div>
</li>
<li>
<p>Enable the {loadbalancer_service} in {OpenShiftShort}:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc patch openstackcontrolplane openstack --type=merge --patch '
spec:
  ovn:
    template:
      ovnController:
        networkAttachment: tenant
        nicMappings:
          octavia: octbr
  octavia:
    enabled: true
    template:
      apacheContainerImage: registry.redhat.io/rhel8/httpd-24:latest
      amphoraImageContainerImage: quay.io/gthiemonge/octavia-amphora-image
      databaseInstance: openstack
      octaviaHousekeeping:
        networkAttachments:
          - octavia
      octaviaHealthManager:
        networkAttachments:
          - octavia
      octaviaWorker:
        networkAttachments:
          - octavia
'</pre>
</div>
</div>
</li>
<li>
<p>Wait for the {loadbalancer_service} control plane services CRs to be ready:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc wait --for condition=Ready --timeout=600s octavia.octavia.openstack.org/octavia</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the {loadbalancer_service} is registered in the {identity_service}:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack service list | grep load-balancer
| bd078ca6f90c4b86a48801f45eb6f0d7 | octavia   | load-balancer |
$ openstack endpoint list | grep load-balancer
| f1ae7756b6164baf9cb82a1a670067a2 | regionOne | octavia      | load-balancer | True    | public    | https://octavia-public-openstack.apps-crc.testing                     |
| ff3222b4621843669e89843395213049 | regionOne | octavia      | load-balancer | True    | internal  | http://octavia-internal.openstack.svc:9876                            |</pre>
</div>
</div>
</li>
<li>
<p>Change the <code>ONBOOT</code> option in the network script for the management interface to <code>no</code> to ensure that the interface is disabled on reboot:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Connect to each of the Controller nodes on the old control plane, for example, <code>overcloud-controller-0</code>.</p>
</li>
<li>
<p>Open the management interface configuration file in a text editor such as <code>vi</code>:</p>
<div class="listingblock">
<div class="content">
<pre>$ sudo vi /etc/sysconfig/network-scripts/ifcfg-o-hm0</pre>
</div>
</div>
<div class="paragraph">
<p>The script name is based on the previous <code>OctaviaMgmtPortDevName</code> setting and might differ in your environment.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Delete old flavors that are migrated to the new control plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack flavor list --all | grep octavia
| 484c351a-57ca-4a4b-8e6e-93d31596fec5 | octavia-amphora-4vcpus   | 4096 |    3 |         0 |     4 | False     |
| 65                                   | octavia_65               | 1024 |    3 |         0 |     1 | False     |
| amphora-mvcpu-ha                     | octavia_amphora-mvcpu-ha | 4096 |    3 |         0 |     4 | False     |
| cf9d1d80-5680-4ed8-a051-e8ec4c5871e0 | octavia-amphora          | 1024 |    3 |         0 |     1 | False     |
$ openstack flavor delete octavia_65
$ openstack flavor delete octavia_amphora-mvcpu-ha
$ openstack flavor list --all | grep octavia
| 484c351a-57ca-4a4b-8e6e-93d31596fec5 | octavia-amphora-4vcpus | 4096 |    3 |         0 |     4 | False     |
| cf9d1d80-5680-4ed8-a051-e8ec4c5871e0 | octavia-amphora        | 1024 |    3 |         0 |     1 | False     |</pre>
</div>
</div>
</li>
<li>
<p>Delete old {loadbalancer_service} flavors that are migrated to the new control plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack loadbalancer flavor list
+--------------------------------------+--------------------------+--------------------------------------+---------+
| id                                   | name                     | flavor_profile_id                    | enabled |
+--------------------------------------+--------------------------+--------------------------------------+---------+
| 5db54d9b-ba08-4b51-a859-0a81533604aa | octavia_amphora-mvcpu-ha | 4fa6a793-4c20-4480-be4f-806912840511 | True    |
| 6d649fd5-6322-4265-b5f3-c3277fc29ec8 | amphora-4vcpus           | d9764a80-99f5-4f22-bbe0-3ddbdc5c485c | True    |
| 93f34308-24a7-42de-9065-959a3b36e7f6 | amphora                  | e75e50c8-7786-4623-abcf-bccbea59d213 | True    |
+--------------------------------------+--------------------------+--------------------------------------+---------+
$ openstack loadbalancer flavor delete octavia_amphora-mvcpu-ha
$ openstack loadbalancer flavor list
+--------------------------------------+----------------+--------------------------------------+---------+
| id                                   | name           | flavor_profile_id                    | enabled |
+--------------------------------------+----------------+--------------------------------------+---------+
| 6d649fd5-6322-4265-b5f3-c3277fc29ec8 | amphora-4vcpus | d9764a80-99f5-4f22-bbe0-3ddbdc5c485c | True    |
| 93f34308-24a7-42de-9065-959a3b36e7f6 | amphora        | e75e50c8-7786-4623-abcf-bccbea59d213 | True    |
+--------------------------------------+----------------+--------------------------------------+---------+</pre>
</div>
</div>
</li>
<li>
<p>Delete old flavor profiles that are migrated to the new control plane:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack loadbalancer flavorprofile list
+--------------------------------------+----------------------------------+---------------+
| id                                   | name                             | provider_name |
+--------------------------------------+----------------------------------+---------------+
| 4fa6a793-4c20-4480-be4f-806912840511 | octavia_amphora-mvcpu-ha_profile | amphora       |
| d9764a80-99f5-4f22-bbe0-3ddbdc5c485c | amphora-4vcpus                   | amphora       |
| e75e50c8-7786-4623-abcf-bccbea59d213 | amphora                          | amphora       |
+--------------------------------------+----------------------------------+---------------+
$ openstack loadbalancer flavorprofile delete octavia_amphora-mvcpu-ha_profile
$ openstack loadbalancer flavorprofile list
+--------------------------------------+----------------+---------------+
| id                                   | name           | provider_name |
+--------------------------------------+----------------+---------------+
| d9764a80-99f5-4f22-bbe0-3ddbdc5c485c | amphora-4vcpus | amphora       |
| e75e50c8-7786-4623-abcf-bccbea59d213 | amphora        | amphora       |
+--------------------------------------+----------------+---------------+</pre>
</div>
</div>
</li>
<li>
<p>Delete the old management network ports. Store the network ID of the old management network in the variable <code>WALLABY_LB_MGMT_NET_ID</code> to use later:</p>
<div class="listingblock">
<div class="content">
<pre>$ for net_id in $(openstack network list -f value -c ID --name lb-mgmt-net); do desc=$(openstack network show "$net_id" -f value -c description); [ -z "$desc" ] &amp;&amp; WALLABY_LB_MGMT_NET_ID="$net_id" ; done
$ echo $WALLABY_LB_MGMT_NET_ID
1e21f9c1-7485-4104-a2f3-eed098ab9cad</pre>
</div>
</div>
</li>
<li>
<p>Delete all ports that are used in this network:</p>
<div class="listingblock">
<div class="content">
<pre>$ for id in $(openstack port list --network "$WALLABY_LB_MGMT_NET_ID" -f value -c ID) ; do openstack port delete "$id" ; done</pre>
</div>
</div>
</li>
<li>
<p>Delete the old management network:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack network delete "$WALLABY_LB_MGMT_NET_ID"</pre>
</div>
</div>
</li>
<li>
<p>Verify that only one <code>lb-mgmt-net</code> and one <code>lb-mgmt-subnet</code> exists:</p>
<div class="listingblock">
<div class="content">
<pre>$ openstack network list | grep lb-mgmt-net
| fe470c29-0482-4809-9996-6d636e3feea3 | lb-mgmt-net          | 6a881091-097d-441c-937b-5a23f4f243b7 |
$ openstack subnet list | grep lb-mgmt-subnet
| 6a881091-097d-441c-937b-5a23f4f243b7 | lb-mgmt-subnet          | fe470c29-0482-4809-9996-6d636e3feea3 | 172.24.0.0/16   |</pre>
</div>
</div>
</li>
</ol>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
