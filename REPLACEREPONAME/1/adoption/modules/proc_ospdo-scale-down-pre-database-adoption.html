<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scaling down director Operator resources :: Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../../..">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="REPLACEREPONAME" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">FIXME Course Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prereqs.html">Perform OpenShift Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install-operators.html">Install the Red Hat OpenStack Platform Service Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../network-isolation.html">Prepare OCP for OpenStack Network Isolation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-overview.html">RHOSP 17.1 to RHOSO 18 adoption overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migrating-databases.html">Migrating RHOSP 17.1 Database to RHOSO 18</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-cp.html">Control plane Adoption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-dp.html">Option - Data plane Adoption</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter1/index.html">Chapter 1</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section2.html">Section 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section3.html">Section 3</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter2/index.html">Chapter 2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter2/section1.html">Section 1</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter3/index.html">Chapter 3</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section2.html">Section 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">FIXME Course Title</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">FIXME Course Title</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">FIXME Course Title</a></li>
    <li><a href="proc_ospdo-scale-down-pre-database-adoption.html">Scaling down director Operator resources</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Scaling down director Operator resources</h1>
<div class="paragraph _abstract">
<p>Before you migrate your databases to the control plane, you must scale down and remove OpenStack director Operator (OSPdO) resources in order to use the {rhos_long} resources.</p>
</div>
<div class="paragraph">
<p>You must perform the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dump selected data from the existing {OpenStackShort} {rhos_prev_ver} cluster. You use this data to build the custom resources for the data plane adoption.</p>
</li>
<li>
<p>After you extract and save the data, remove the OSPdO control plane and operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download the NIC templates:</p>
<div class="listingblock">
<div class="content">
<pre>    # Make temp directory if doesn't exist
    mkdir -p temp
    cd temp
    echo "Extract nic templates"
    oc get -n "${OSPDO_NAMESPACE}" cm tripleo-tarball -ojson | jq -r '.binaryData."tripleo-tarball.tar.gz"' | base64 -d | tar xzvf -
    # Revert back to original directory
    cd -</pre>
</div>
</div>
</li>
<li>
<p>Get the SSH key for accessing the data plane nodes:</p>
<div class="listingblock">
<div class="content">
<pre>    # Make temp directory if doesn't exist
    mkdir -p temp
    # Get the SSH key from the openstackclient (osp 17)
    # to be used later to create the SSH secret for dataplane adoption
    $OS_CLIENT cat /home/cloud-admin/.ssh/id_rsa &gt; temp/ssh.private
    $OS_CLIENT cat /home/cloud-admin/.ssh/id_rsa.pub &gt; temp/ssh.pub
    echo "SSH private and public keys saved in temp/ssh.private and temp/ssh.pub"</pre>
</div>
</div>
</li>
<li>
<p>Get the OVN configuration from each Compute node role, <code>OpenStackBaremetalSet</code>. This configuration is  used later to build the <code>OpenStackDataPlaneNodeSet</code>(s). Repeat the following step for each <code>OpenStackBaremetalSet</code>:</p>
<div class="listingblock">
<div class="content">
<pre>    # Make temp directory if doesn't exist
    mkdir -p temp
        #
        # Query the first node in OSBMS
        #
    IP=$(oc -n "${OSPDO_NAMESPACE}" get openstackbaremetalsets.osp-director.openstack.org &lt;&lt;OSBMS-NAME&gt;&gt; -ojson |           jq -r '.status.baremetalHosts| keys[] as $k | .[$k].ipaddresses["ctlplane"]'| awk -F'/' '{print $1}')
    # Get the OVN parameters
    oc -n "${OSPDO_NAMESPACE}" exec -c openstackclient openstackclient -- \
        ssh cloud-admin@${IP} sudo ovs-vsctl -f json --columns=external_ids list Open |
        jq -r '.data[0][0][1][]|join("=")' | sed -n -E 's/^(ovn.*)+=(.*)+/edpm_\1: \2/p' |
        grep -v -e ovn-remote -e encap-tos -e openflow -e ofctrl &gt; temp/&lt;&lt;OSBMS-NAME&gt;&gt;.txt</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>    # Create temp directory if it does not exist
    mkdir -p temp
    for name in $(oc -n "${OSPDO_NAMESPACE}" get openstackbaremetalsets.osp-director.openstack.org | awk 'NR &gt; 1 {print $1}'); do
      oc -n "${OSPDO_NAMESPACE}" get openstackbaremetalsets.osp-director.openstack.org $name -ojson |
          jq -r '.status.baremetalHosts| "nodes:", keys[] as $k | .[$k].ipaddresses as $a |
           "  \($k):",
           "    hostName: \($k)",
           "    ansible:",
           "      ansibleHost: \($a["ctlplane"] | sub("/\\d+"; ""))",
           "    networks:", ($a | to_entries[] | "    - name: \(.key) \n      fixedIP: \(.value | sub("/\\d+"; ""))\n      subnetName: subnet1")' &gt; temp/${name}-nodes.txt
    done</pre>
</div>
</div>
</li>
<li>
<p>Remove the conflicting repositories and packages from all Compute hosts. Define the OSPdO and {OpenStackShort} {rhos_prev_ver} Pacemaker services that must be stopped:</p>
<div class="listingblock">
<div class="content">
<pre>PacemakerResourcesToStop_dataplane=(
                "galera-bundle"
                "haproxy-bundle"
                "rabbitmq-bundle")

# Stop these PCM services after adopting control
# plane, but before starting deletion of OSPD0 (osp17) env
    echo "Stopping pacemaker OpenStack services"
    SSH_CMD=CONTROLLER_SSH
    if [ -n "${!SSH_CMD}" ]; then
        echo "Using controller 0 to run pacemaker commands "
        for resource in "${PacemakerResourcesToStop_dataplane[@]}"; do
            if ${!SSH_CMD} sudo pcs resource config "$resource" &amp;&gt;/dev/null; then
                echo "Stopping $resource"
                ${!SSH_CMD} sudo pcs resource disable "$resource"
            else
                echo "Service $resource not present"
            fi
        done
    fi</pre>
</div>
</div>
</li>
<li>
<p>Scale down the {rhos_acro} OpenStack Operator <code>controller-manager</code> to 0 replicas and temporarily delete the <code>OpenStackControlPlane</code> <code>OpenStackClient</code> pod, so that you can use the OSPdO <code>controller-manager</code> to clean up some of its resources. The cleanup is needed to avoid a pod name collision between the OSPdO OpenStackClient and the {rhos_acro} OpenStackClient.</p>
<div class="listingblock">
<div class="content">
<pre>$ oc patch csv -n openstack-operators openstack-operator.v1.0.5 --type json   -p="[{"op": "replace", "path": "/spec/install/spec/deployments/0/spec/replicas", "value": "0"}]"
$ oc delete openstackclients.client.openstack.org --all</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace the CSV version with the CSV version that is deployed in the cluster.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Delete the OSPdO <code>OpenStackControlPlane</code> custom resource (CR):</p>
<div class="listingblock">
<div class="content">
<pre>$ oc delete openstackcontrolplanes.osp-director.openstack.org -n "${OSPDO_NAMESPACE}" --all</pre>
</div>
</div>
</li>
<li>
<p>Delete the OSPdO <code>OpenStackNetConfig</code> CR to remove the associated node network configuration policies:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc delete osnetconfig -n "${OSPDO_NAMESPACE}" --all</pre>
</div>
</div>
</li>
<li>
<p>Label the {OpenShiftShort} node that contains the OSPdO virtual machine (VM):</p>
<div class="listingblock">
<div class="content">
<pre>$ oc label nodes &lt;ospdo_vm_master_node&gt; type=openstack</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace <code>&lt;ospdo_vm_master_node&gt;</code> with the remaining master node that contains the OSPdO VM.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a node network configuration policy for the third {OpenShiftShort} node. For example:</p>
<div class="listingblock">
<div class="content">
<pre>$ cat &lt;&lt; EOF &gt; /tmp/node3_nncp.yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  labels:
    osp/interface: enp7s0
  name: &lt;ostest-master-node&gt;
spec:
  desiredState:
    dns-resolver:
      config:
        search: []
        server:
        - 172.22.0.1
    interfaces:
    - description: internalapi vlan interface
      name: enp7s0.20
      state: up
      type: vlan
      vlan:
        base-iface: enp7s0
        id: 20
        reorder-headers: true
      ipv4:
        address:
        - ip: 172.17.0.7
          prefix-length: 24
        enabled: true
        dhcp: false
      ipv6:
        enabled: false
    - description: storage vlan interface
      name: enp7s0.30
      state: up
      type: vlan
      vlan:
        base-iface: enp7s0
        id: 30
        reorder-headers: true
      ipv4:
        address:
        - ip: 172.18.0.7
          prefix-length: 24
        enabled: true
        dhcp: false
      ipv6:
        enabled: false
    - description: storagemgmt vlan interface
      name: enp7s0.40
      state: up
      type: vlan
      vlan:
        base-iface: enp7s0
        id: 40
        reorder-headers: true
      ipv4:
        address:
        - ip: 172.19.0.7
          prefix-length: 24
        enabled: true
        dhcp: false
      ipv6:
        enabled: false
    - description: tenant vlan interface
      name: enp7s0.50
      state: up
      type: vlan
      vlan:
        base-iface: enp7s0
        id: 50
        reorder-headers: true
      ipv4:
        address:
        - ip: 172.20.0.7
          prefix-length: 24
        enabled: true
        dhcp: false
      ipv6:
        enabled: false
    - description: Configuring Bridge br-ctlplane with interface enp7s0
      name: br-ctlplane
      mtu: 1500
      type: linux-bridge
      state: up
      bridge:
        options:
          stp:
            enabled: false
        port:
          - name: enp1s0
            vlan: {}
      ipv4:
        address:
        - ip: 172.22.0.53
          prefix-length: 24
        enabled: true
        dhcp: false
      ipv6:
        enabled: false
    - bridge:
        options:
          stp:
            enabled: false
        port:
        - name: enp6s0
      description: Linux bridge with enp6s0 as a port
      ipv4:
        enabled: false
      ipv6:
        enabled: false
      mtu: 1500
      name: br-external
      state: up
      type: linux-bridge
  nodeSelector:
    kubernetes.io/hostname: &lt;ostest-master-node&gt;
    node-role.kubernetes.io/worker: ""
EOF

$ oc apply -f /tmp/node3_nncp.yaml</pre>
</div>
</div>
</li>
<li>
<p>Delete the remaining OSPdO resources. Do not delete the <code>OpenStackBaremetalSets</code> and <code>OpenStackProvisionServer</code> resources:</p>
<div class="listingblock">
<div class="content">
<pre>$ for i in $(oc get crd | grep osp-director | grep -v baremetalset | grep -v provisionserver | awk {'print $1'}); do echo Deleting $i...; oc delete $i -n "${OSPDO_NAMESPACE}" --all; done</pre>
</div>
</div>
</li>
<li>
<p>Scale down OSPdO to 0 replicas:</p>
<div class="listingblock">
<div class="content">
<pre>$ ospdo_csv_ver=$(oc get csv -n "${OSPDO_NAMESPACE}" -l operators.coreos.com/osp-director-operator.openstack -o json | jq -r '.items[0].metadata.name')
$ oc patch csv -n "${OSPDO_NAMESPACE}" $ospdo_csv_ver --type json   -p="[{"op": "replace", "path": "/spec/install/spec/deployments/0/spec/replicas", "value": "0"}]"</pre>
</div>
</div>
</li>
<li>
<p>Remove the webhooks from OSPdO:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc patch csv $ospdo_csv_ver -n "${OSPDO_NAMESPACE}" --type json -p="[{"op": "remove", "path": "/spec/webhookdefinitions"}]"</pre>
</div>
</div>
</li>
<li>
<p>Remove the finalizer from the OSPdO <code>OpenStackBaremetalSet</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc patch openstackbaremetalsets.osp-director.openstack.org -n "${OSPDO_NAMESPACE}" compute --type json -p="[{"op": "remove", "path": "/metadata/finalizers"}]"</pre>
</div>
</div>
</li>
<li>
<p>Delete the <code>OpenStackBaremetalSet</code> and <code>OpenStackProvisionServer</code> resources:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc delete openstackbaremetalsets.osp-director.openstack.org -n "${OSPDO_NAMESPACE}" --all
$ oc delete openstackprovisionservers.osp-director.openstack.org -n "${OSPDO_NAMESPACE}" --all</pre>
</div>
</div>
</li>
<li>
<p>Annotate each {OpenStackShort} Compute <code>BareMetalHost</code> resource so that Metal3 does not start the node:</p>
<div class="listingblock">
<div class="content">
<pre>$ compute_bmh_list=$(oc get bmh -n openshift-machine-api |grep compute|awk '{printf $1 " "}')
$ for bmh_compute in $compute_bmh_list;do oc annotate bmh -n openshift-machine-api $bmh_compute baremetalhost.metal3.io/detached="";\
     oc -n openshift-machine-api wait bmh/$bmh_compute --for=jsonpath='{.status.operationalStatus}'=detached --timeout=30s || {
         echo "ERROR: BMH did not enter detatched state"
         exit 1
       }
done</pre>
</div>
</div>
</li>
<li>
<p>Delete the <code>BareMetalHost</code> resource after its operational status is detached:</p>
<div class="listingblock">
<div class="content">
<pre>    for bmh_compute in $compute_bmh_list;do \
       oc -n openshift-machine-api delete bmh $bmh_compute; \
    done</pre>
</div>
</div>
</li>
<li>
<p>Delete the OSPdO Operator Lifecycle Manager resources to remove OSPdO:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc delete subscription osp-director-operator -n "${OSPDO_NAMESPACE}"
$ oc delete operatorgroup osp-director-operator -n "${OSPDO_NAMESPACE}"
$ oc delete catalogsource osp-director-operator-index -n "${OSPDO_NAMESPACE}"
$ oc delete csv $ospdo_csv_ver -n "${OSPDO_NAMESPACE}"</pre>
</div>
</div>
</li>
<li>
<p>Scale up the {rhos_acro} OpenStack Operator <code>controller-manager</code> to 1 replica so that the associated <code>OpenStackControlPlane</code> CR is reconciled and its <code>OpenStackClient</code> pod is recreated:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc patch csv -n "${OSPDO_NAMESPACE}"-operators openstack-operator.v0.0.1 --type json   -p="[{"op": "replace", "path": "/spec/install/spec/deployments/0/spec/replicas", "value": "1"}]"</pre>
</div>
</div>
</li>
</ol>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
