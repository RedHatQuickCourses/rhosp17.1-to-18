<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Migrating databases to MariaDB instances :: Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../../..">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="REPLACEREPONAME" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">FIXME Course Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Upgrade a RHOSP 17.1 to RHOSO 18 using the adoption mechanism</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prereqs.html">Perform OpenShift Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install-operators.html">Install the Red Hat OpenStack Platform Service Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../network-isolation.html">Prepare OCP for OpenStack Network Isolation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-overview.html">RHOSP 17.1 to RHOSO 18 adoption overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migrating-databases.html">Migrating RHOSP 17.1 Database to RHOSO 18</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-cp.html">Control plane Adoption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adoption-dp.html">Option - Data plane Adoption</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter1/index.html">Chapter 1</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section2.html">Section 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter1/section3.html">Section 3</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter2/index.html">Chapter 2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter2/section1.html">Section 1</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../chapter3/index.html">Chapter 3</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section1.html">Section 1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../chapter3/section2.html">Section 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">FIXME Course Title</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">FIXME Course Title</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">FIXME Course Title</a></li>
    <li><a href="proc_migrating-databases-to-mariadb-instances.html">Migrating databases to MariaDB instances</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Migrating databases to MariaDB instances</h1>
<div class="paragraph _abstract">
<p>Migrate your databases from the original {rhos_prev_long} ({OpenStackShort}) deployment to the MariaDB instances in the {rhocp_long} cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that the control plane MariaDB and RabbitMQ are running, and that no other control plane services are running.</p>
</li>
<li>
<p>Retrieve the topology-specific service configuration. For more information, see <a href="#proc_retrieving-topology-specific-service-configuration_migrating-databases">Retrieving topology-specific service configuration</a>.</p>
</li>
<li>
<p>Stop the {OpenStackShort} services. For more information, see <a href="#stopping-openstack-services_{context}">Stopping {rhos_prev_long} services</a>.</p>
</li>
<li>
<p>Ensure that there is network routability between the original MariaDB and the MariaDB for the control plane.</p>
</li>
<li>
<p>Define the following shell variables. Replace the following example values with values that are correct for your environment:</p>
<div class="listingblock">
<div class="content">
<pre>$ CELLS="default cell1 cell2" <i class="conum" data-value="1"></i><b>(1)</b>
$ DEFAULT_CELL_NAME="cell3"
$ RENAMED_CELLS="cell1 cell2 $DEFAULT_CELL_NAME"

$ CHARACTER_SET=utf8 <i class="conum" data-value="2"></i><b>(2)</b>
$ COLLATION=utf8_general_ci

$ declare -A PODIFIED_DB_ROOT_PASSWORD
$ for CELL in $(echo "super $RENAMED_CELLS"); do
&gt;   PODIFIED_DB_ROOT_PASSWORD[$CELL]=$(oc get -o json secret/osp-secret | jq -r .data.DbRootPassword | base64 -d)
&gt; done

$ declare -A PODIFIED_MARIADB_IP
$ for CELL in $(echo "super $RENAMED_CELLS"); do
&gt;   if [ "$CELL" = "super" ]; then
&gt;     PODIFIED_MARIADB_IP[$CELL]=$(oc get svc --selector "mariadb/name=openstack" -ojsonpath='{.items[0].spec.clusterIP}')
&gt;   else
&gt;     PODIFIED_MARIADB_IP[$CELL]=$(oc get svc --selector "mariadb/name=openstack-$CELL" -ojsonpath='{.items[0].spec.clusterIP}')
&gt;   fi
&gt; done

$ declare -A TRIPLEO_PASSWORDS
$ for CELL in $(echo $CELLS); do
&gt;   if [ "$CELL" = "default" ]; then
&gt;     TRIPLEO_PASSWORDS[default]="$HOME/overcloud-passwords.yaml"
&gt;   else
&gt;     # in a split-stack source cloud, it should take a stack-specific passwords file instead
&gt;     TRIPLEO_PASSWORDS[$CELL]="$HOME/overcloud-passwords.yaml"
&gt;   fi
&gt; done

$ declare -A SOURCE_DB_ROOT_PASSWORD
$ for CELL in $(echo $CELLS); do
&gt;   SOURCE_DB_ROOT_PASSWORD[$CELL]=$(cat ${TRIPLEO_PASSWORDS[$CELL]} | grep ' MysqlRootPassword:' | awk -F ': ' '{ print $2; }')
&gt; done

$ declare -A SOURCE_MARIADB_IP
$ SOURCE_MARIADB_IP[default]=*&lt;galera cluster VIP&gt;* <i class="conum" data-value="3"></i><b>(3)</b>
$ SOURCE_MARIADB_IP[cell1]=*&lt;galera cell1 cluster VIP&gt;* <i class="conum" data-value="4"></i><b>(4)</b>
$ SOURCE_MARIADB_IP[cell2]=*&lt;galera cell2 cluster VIP&gt;* <i class="conum" data-value="5"></i><b>(5)</b>
# ...

$ declare -A SOURCE_GALERA_MEMBERS_DEFAULT
$ SOURCE_GALERA_MEMBERS_DEFAULT=(
&gt;   ["standalone.localdomain"]=172.17.0.100 <i class="conum" data-value="6"></i><b>(6)</b>
&gt;   # [...]=...
&gt; )
$ declare -A SOURCE_GALERA_MEMBERS_CELL1
$ SOURCE_GALERA_MEMBERS_CELL1=(
&gt;   # ...
&gt; )
$ declare -A SOURCE_GALERA_MEMBERS_CELL2
$ SOURCE_GALERA_MEMBERS_CELL2=(
&gt;   # ...
&gt; )</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CELLS</code> and <code>RENAMED_CELLS</code> represent changes that are going to be made after you import the databases. The <code>default</code> cell takes a new name from <code>DEFAULT_CELL_NAME</code>.
In a multi-cell adoption scenario, <code>default</code> cell might retain its original 'default' name as well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CHARACTER_SET</code> variable and collation should match the source database. If they do not match, then foreign key relationships break for any tables that are created in the future as part of database sync.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add data in  <code>SOURCE_MARIADB_IP[*]= &#8230;&#8203;</code> for each cell that is defined in <code>CELLS</code>. Provide records for the cell names and VIP addresses of MariaDB Galera clusters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>&lt;galera_cell1_cluster_VIP&gt;</code> with the VIP of your galera cell1 cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Replace <code>&lt;galera_cell2_cluster_VIP&gt;</code> with the VIP of your galera cell2 cluster, and so on.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>For each cell defined in <code>CELLS</code>, in <code>SOURCE_GALERA_MEMBERS_CELL&lt;X&gt;</code>, add the names of the MariaDB Galera cluster members and its IP address. Replace <code>["standalone.localdomain"]="172.17.0.100"</code> with the real hosts data.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A standalone {OpenStackPreviousInstaller} environment only creates a 'default' cell, which should be the only <code>CELLS</code> value in this case. The <code>DEFAULT_CELL_NAME</code> value should be <code>cell1</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>super</code> is the top-scope Nova API upcall database instance. A super conductor connects to that database. In subsequent examples, the upcall and cells databases use the same password that is defined in <code>osp-secret</code>. Old passwords are only needed to prepare the data exports.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>To get the values for <code>SOURCE_MARIADB_IP</code>, query the puppet-generated configurations in the Controller and CellController nodes:</p>
<div class="listingblock">
<div class="content">
<pre>$ sudo grep -rI 'listen mysql' -A10 /var/lib/config-data/puppet-generated/ | grep bind</pre>
</div>
</div>
</li>
<li>
<p>To get the values for <code>SOURCE_GALERA_MEMBERS_*</code>, query the puppet-generated configurations in the Controller and CellController nodes:</p>
<div class="listingblock">
<div class="content">
<pre>$ sudo grep -rI 'listen mysql' -A10 /var/lib/config-data/puppet-generated/ | grep server</pre>
</div>
</div>
<div class="paragraph">
<p>The source cloud always uses the same password for cells databases. For that reason, the same passwords file is used for all cells stacks. However, split-stack topology allows using different passwords files for each stack.</p>
</div>
</li>
<li>
<p>Prepare the MariaDB adoption helper pod:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a temporary volume claim and a pod for the database data copy. Edit the volume claim storage request if necessary, to give it enough space for the overcloud databases:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc apply -f - &lt;&lt;EOF
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb-data
spec:
  storageClassName: $STORAGE_CLASS
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: mariadb-copy-data
  annotations:
    openshift.io/scc: anyuid
    k8s.v1.cni.cncf.io/networks: internalapi
  labels:
    app: adoption
spec:
  containers:
  - image: $MARIADB_IMAGE
    command: [ "sh", "-c", "sleep infinity"]
    name: adoption
    volumeMounts:
    - mountPath: /backup
      name: mariadb-data
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop: ALL
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  volumes:
  - name: mariadb-data
    persistentVolumeClaim:
      claimName: mariadb-data
EOF</pre>
</div>
</div>
</li>
<li>
<p>Wait for the pod to be ready:</p>
<div class="listingblock">
<div class="content">
<pre>$ oc wait --for condition=Ready pod/mariadb-copy-data --timeout=30s</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Check that the source Galera database clusters in each cell have its members online and synced:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo $CELLS); do
&gt;   MEMBERS=SOURCE_GALERA_MEMBERS_$(echo ${CELL}|tr '[:lower:]' '[:upper:]')[@]
&gt;   for i in "${!MEMBERS}"; do
&gt;     echo "Checking for the database node $i WSREP status Synced"
&gt;     oc rsh mariadb-copy-data mysql \
&gt;       -h "$i" -uroot -p"${SOURCE_DB_ROOT_PASSWORD[$CELL]}" \
&gt;       -e "show global status like 'wsrep_local_state_comment'" | \
&gt;       grep -qE "\bSynced\b"
&gt;   done
&gt; done</pre>
</div>
</div>
<div class="paragraph">
<p>Each additional {compute_service_first_ref} v2 cell runs a dedicated Galera database cluster, so the command checks each cell.</p>
</div>
</li>
<li>
<p>Get the count of source databases with the <code>NOK</code> (not-OK) status:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo $CELLS); do
&gt;   oc rsh mariadb-copy-data mysql -h "${SOURCE_MARIADB_IP[$CELL]}" -uroot -p"${SOURCE_DB_ROOT_PASSWORD[$CELL]}" -e "SHOW databases;"
&gt; end</pre>
</div>
</div>
</li>
<li>
<p>Check that <code>mysqlcheck</code> had no errors:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo $CELLS); do
&gt;   set +u
&gt;   . ~/.source_cloud_exported_variables_$CELL
&gt;   set -u
&gt; done
$ test -z "$PULL_OPENSTACK_CONFIGURATION_MYSQLCHECK_NOK"  || [ "x$PULL_OPENSTACK_CONFIGURATION_MYSQLCHECK_NOK" = "x " ] &amp;&amp; echo "OK" || echo "CHECK FAILED"</pre>
</div>
</div>
</li>
<li>
<p>Test the connection to the control plane upcall and cells databases:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo "super $RENAMED_CELLS"); do
&gt;   oc run mariadb-client --image $MARIADB_IMAGE -i --rm --restart=Never -- \
&gt;     mysql -rsh "${PODIFIED_MARIADB_IP[$CELL]}" -uroot -p"${PODIFIED_DB_ROOT_PASSWORD[$CELL]}" -e 'SHOW databases;'
&gt; done</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You must transition Compute services that you import later into a superconductor architecture by deleting the old service records in the cell databases, starting with <code>cell1</code>. New records are registered with different hostnames that are provided by the {compute_service} operator. All Compute services, except the Compute agent, have no internal state, and you can safely delete their service records. You also need to rename the former <code>default</code> cell to <code>DEFAULT_CELL_NAME</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a dump of the original databases:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo $CELLS); do
&gt;   oc rsh mariadb-copy-data &lt;&lt; EOF
&gt;     mysql -h"${SOURCE_MARIADB_IP[$CELL]}" -uroot -p"${SOURCE_DB_ROOT_PASSWORD[$CELL]}" \
&gt;     -N -e "show databases" | grep -E -v "schema|mysql|gnocchi|aodh" | \
&gt;     while read dbname; do
&gt;       echo "Dumping $CELL cell \${dbname}";
&gt;       mysqldump -h"${SOURCE_MARIADB_IP[$CELL]}" -uroot -p"${SOURCE_DB_ROOT_PASSWORD[$CELL]}" \
&gt;         --single-transaction --complete-insert --skip-lock-tables --lock-tables=0 \
&gt;         "\${dbname}" &gt; /backup/"${CELL}.\${dbname}".sql;
&gt;     done
&gt; EOF
&gt; done</pre>
</div>
</div>
<div class="paragraph">
<p>Note filtering the information and performance schema tables.
Gnocchi is no longer used as a metric store as well</p>
</div>
</li>
<li>
<p>Restore the databases from <code>.sql</code> files into the control plane MariaDB:</p>
<div class="listingblock">
<div class="content">
<pre>$ for CELL in $(echo $CELLS); do
&gt;   RCELL=$CELL
&gt;   [ "$CELL" = "default" ] &amp;&amp; RCELL=$DEFAULT_CELL_NAME
&gt;   oc rsh mariadb-copy-data &lt;&lt; EOF
&gt;     declare -A db_name_map  <i class="conum" data-value="1"></i><b>(1)</b>
&gt;     db_name_map['nova']="nova_$RCELL"
&gt;     db_name_map['ovs_neutron']='neutron'
&gt;     db_name_map['ironic-inspector']='ironic_inspector'
&gt;     declare -A db_cell_map  <i class="conum" data-value="2"></i><b>(2)</b>
&gt;     db_cell_map['nova']="nova_$DEFAULT_CELL_NAME"
&gt;     db_cell_map["nova_$RCELL"]="nova_$RCELL"  <i class="conum" data-value="3"></i><b>(3)</b>
&gt;     declare -A db_server_map  <i class="conum" data-value="4"></i><b>(4)</b>
&gt;     db_server_map['default']=${PODIFIED_MARIADB_IP['super']}
&gt;     db_server_map["nova"]=${PODIFIED_MARIADB_IP[$DEFAULT_CELL_NAME]}
&gt;     db_server_map["nova_$RCELL"]=${PODIFIED_MARIADB_IP[$RCELL]}
&gt;     declare -A db_server_password_map  <i class="conum" data-value="5"></i><b>(5)</b>
&gt;     db_server_password_map['default']=${PODIFIED_DB_ROOT_PASSWORD['super']}
&gt;     db_server_password_map["nova"]=${PODIFIED_DB_ROOT_PASSWORD[$DEFAULT_CELL_NAME]}
&gt;     db_server_password_map["nova_$RCELL"]=${PODIFIED_DB_ROOT_PASSWORD[$RCELL]}
&gt;     cd /backup
&gt;     for db_file in \$(ls ${CELL}.*.sql); do
&gt;       db_name=\$(echo \${db_file} | awk -F'.' '{ print \$2; }')
&gt;       [[ "$CELL" != "default" &amp;&amp; ! -v "db_cell_map[\${db_name}]" ]] &amp;&amp; continue
&gt;       if [[ "$CELL" == "default" &amp;&amp; -v "db_cell_map[\${db_name}]" ]] ; then
&gt;         target=$DEFAULT_CELL_NAME
&gt;       elif [[ "$CELL" == "default" &amp;&amp; ! -v "db_cell_map[\${db_name}]" ]] ; then
&gt;         target=super
&gt;       else
&gt;         target=$RCELL
&gt;       fi  <i class="conum" data-value="6"></i><b>(6)</b>
&gt;       renamed_db_file="\${target}_new.\${db_name}.sql"
&gt;       mv -f \${db_file} \${renamed_db_file}
&gt;       if [[ -v "db_name_map[\${db_name}]" ]]; then
&gt;         echo "renaming $CELL cell \${db_name} to \$target \${db_name_map[\${db_name}]}"
&gt;         db_name=\${db_name_map[\${db_name}]}
&gt;       fi
&gt;       db_server=\${db_server_map["default"]}
&gt;       if [[ -v "db_server_map[\${db_name}]" ]]; then
&gt;         db_server=\${db_server_map[\${db_name}]}
&gt;       fi
&gt;       db_password=\${db_server_password_map['default']}
&gt;       if [[ -v "db_server_password_map[\${db_name}]" ]]; then
&gt;         db_password=\${db_server_password_map[\${db_name}]}
&gt;       fi
&gt;       echo "creating $CELL cell \${db_name} in \$target \${db_server}"
&gt;       mysql -h"\${db_server}" -uroot "-p\${db_password}" -e \
&gt;         "CREATE DATABASE IF NOT EXISTS \${db_name} DEFAULT \
&gt;         CHARACTER SET ${CHARACTER_SET} DEFAULT COLLATE ${COLLATION};"
&gt;       echo "importing $CELL cell \${db_name} into \$target \${db_server} from \${renamed_db_file}"
&gt;       mysql -h "\${db_server}" -uroot "-p\${db_password}" "\${db_name}" &lt; "\${renamed_db_file}"
&gt;     done
&gt;     if [ "$CELL" = "default" ] ; then
&gt;       mysql -h "\${db_server_map['default']}" -uroot -p"\${db_server_password_map['default']}" -e \
&gt;         "update nova_api.cell_mappings set name='$DEFAULT_CELL_NAME' where name='default';"
&gt;     fi
&gt;     mysql -h "\${db_server_map["nova_$RCELL"]}" -uroot -p"\${db_server_password_map["nova_$RCELL"]}" -e \
&gt;       "delete from nova_${RCELL}.services where host not like '%nova_${RCELL}-%' and services.binary != 'nova-compute';"
&gt; EOF
&gt; done</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defines which common databases to rename when importing them.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines which cells databases to import, and how to rename them, if needed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Omits importing special <code>cell0</code> databases of the cells, as its contents cannot be consolidated during adoption.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Defines which databases to import into which servers, usually dedicated for cells.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Defines the root passwords map for database servers. You can only use the same password for now.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Assigns which databases to import into which hosts when extracting databases from the <code>default</code> cell.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>Compare the following outputs with the topology-specific service configuration.
For more information, see <a href="#proc_retrieving-topology-specific-service-configuration_migrating-databases">Retrieving topology-specific service configuration</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check that the databases are imported correctly:</p>
<div class="listingblock">
<div class="content">
<pre>$ set +u
$ . ~/.source_cloud_exported_variables_default
$ set -u
$ dbs=$(oc exec openstack-galera-0 -c galera -- mysql -rs -uroot -p"${PODIFIED_DB_ROOT_PASSWORD['super']}" -e 'SHOW databases;')
$ echo $dbs | grep -Eq '\bkeystone\b' &amp;&amp; echo "OK" || echo "CHECK FAILED"
$ echo $dbs | grep -Eq '\bneutron\b' &amp;&amp; echo "OK" || echo "CHECK FAILED"
$ echo "${PULL_OPENSTACK_CONFIGURATION_DATABASES[@]}" | grep -Eq '\bovs_neutron\b' &amp;&amp; echo "OK" || echo "CHECK FAILED" <i class="conum" data-value="1"></i><b>(1)</b>
$ novadb_mapped_cells=$(oc exec openstack-galera-0 -c galera -- mysql -rs -uroot -p"${PODIFIED_DB_ROOT_PASSWORD['super']}" \
&gt;   nova_api -e 'select uuid,name,transport_url,database_connection,disabled from cell_mappings;') <i class="conum" data-value="2"></i><b>(2)</b>
$ uuidf='\S{8,}-\S{4,}-\S{4,}-\S{4,}-\S{12,}'
$ default=$(printf "%s\n" "$PULL_OPENSTACK_CONFIGURATION_NOVADB_MAPPED_CELLS" | sed -rn "s/^($uuidf)\s+default\b.*$/\1/p")
$ difference=$(diff -ZNua \
&gt;   &lt;(printf "%s\n" "$PULL_OPENSTACK_CONFIGURATION_NOVADB_MAPPED_CELLS") \
&gt;   &lt;(printf "%s\n" "$novadb_mapped_cells")) || true
$ if [ "$DEFAULT_CELL_NAME" != "default" ]; then
&gt;   printf "%s\n" "$difference" | grep -qE "^\-$default\s+default\b" &amp;&amp; echo "OK" || echo "CHECK FAILED"
&gt;   printf "%s\n" "$difference" | grep -qE "^\+$default\s+$DEFAULT_CELL_NAME\b" &amp;&amp; echo "OK" || echo "CHECK FAILED"
&gt;   [ $(grep -E "^[-\+]$uuidf" &lt;&lt;&lt;"$difference" | wc -l) -eq 2 ] &amp;&amp; echo "OK" || echo "CHECK FAILED"
&gt; else
&gt;   [ "x$difference" = "x" ] &amp;&amp; echo "OK" || echo "CHECK FAILED"
&gt; fi
$ for CELL in $(echo $RENAMED_CELLS); do <i class="conum" data-value="3"></i><b>(3)</b>
&gt;   RCELL=$CELL
&gt;   [ "$CELL" = "$DEFAULT_CELL_NAME" ] &amp;&amp; RCELL=default
&gt;   set +u
&gt;   . ~/.source_cloud_exported_variables_$RCELL
&gt;   set -u
&gt;   c1dbs=$(oc exec openstack-$CELL-galera-0 -c galera -- mysql -rs -uroot -p${PODIFIED_DB_ROOT_PASSWORD[$CELL]} -e 'SHOW databases;') <i class="conum" data-value="4"></i><b>(4)</b>
&gt;   echo $c1dbs | grep -Eq "\bnova_${CELL}\b" &amp;&amp; echo "OK" || echo "CHECK FAILED"
&gt;   novadb_svc_records=$(oc exec openstack-$CELL-galera-0 -c galera -- mysql -rs -uroot -p${PODIFIED_DB_ROOT_PASSWORD[$CELL]} \
&gt;     nova_$CELL -e "select host from services where services.binary='nova-compute' and deleted=0 order by host asc;")
&gt;   diff -Z &lt;(echo "x$novadb_svc_records") &lt;(echo "x${PULL_OPENSTACK_CONFIGURATION_NOVA_COMPUTE_HOSTNAMES[@]}") &amp;&amp; echo "OK" || echo "CHECK FAILED" <i class="conum" data-value="5"></i><b>(5)</b>
&gt; done</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ensures that the {networking_first_ref} database is renamed from <code>ovs_neutron</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ensures that the <code>default</code> cell is renamed to <code>$DEFAULT_CELL_NAME</code>, and the cell UUIDs are retained.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ensures that the registered Compute services names have not changed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ensures {compute_service} cells databases are extracted to separate database servers, and renamed from <code>nova</code> to <code>nova_cell&lt;X&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Ensures that the registered {compute_service} name has not changed.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Delete the <code>mariadb-data</code> pod and the <code>mariadb-copy-data</code> persistent volume claim that contains the database backup:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Consider taking a snapshot of them before deleting.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc delete pod mariadb-copy-data
$ oc delete pvc mariadb-data</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
During the pre-checks and post-checks, the <code>mariadb-client</code> pod might return a pod security warning related to the <code>restricted:latest</code> security context constraint. This warning is due to default security context constraints and does not prevent the admission controller from creating a pod. You see a warning for the short-lived pod, but it does not interfere with functionality.
For more information, see <a href="https://learn.redhat.com/t5/DO280-Red-Hat-OpenShift/About-pod-security-standards-and-warnings/m-p/32502">About pod security standards and warnings</a>.
</td>
</tr>
</table>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
